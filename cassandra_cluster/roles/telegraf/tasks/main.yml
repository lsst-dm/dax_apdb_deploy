#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/telegraf

- name: "Check for /etc/telegraf/telegraf.d"
  ansible.builtin.stat:
    path: /etc/telegraf/telegraf.d
  register: etc_telegraf

- block:
  - name: "Install telegraf config for cassandra"
    ansible.builtin.template:
      src: "./90-cassandra.conf.j2"
      dest: "/etc/telegraf/telegraf.d/90-cassandra.conf"
      mode: "0644"
  - name: "Install telegraf filter script"
    ansible.builtin.copy:
      src: "files/cassandra-metrics-rename.py"
      dest: "/etc/telegraf/telegraf.d/cassandra-metrics-rename.py"
      mode: "0644"
  - name: "Restart telegraf service"
    ansible.builtin.service:
      name: "telegraf"
      state: "restarted"

  become: true
  become_method: "ansible.builtin.sudo"
  when: etc_telegraf.stat.exists
